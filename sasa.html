<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobage: footer-color" content="none" />
    <title>ｱｲﾄﾞﾙﾏｽﾀｰ SideM</title>



    <script>
        var isShellApp = false;
        var isChromeApp = false;
        var isAndApp = false;
        var isFullWidth = false;
    </script>


    <link rel="stylesheet" type="text/css" media="all" href="?url=http%3A%2F%2Fm.i-sidem.idolmaster.jp%2Ftmp%2Fcss_c8d240d681f5c5da39cf23d1a6274110.css" />
    <link rel="stylesheet" type="text/css" href="http://sp.pf-img-a.mbga.jp/css/base.css?20171116" />
</head>

<body class="bgbasestar">
    <script type="text/javascript" src="?url=http%3A%2F%2Fm.i-sidem.idolmaster.jp%2Ftmp%2Fjs_b6f548231bbf2db2fec7754df524f200.js"></script>
    <div id="layout">


        <div class="posr">
            <div class="dnone posa" style="height:400px;width:320px;top:0;left:0;z-index:1;    
-webkit-touch-callout: none;
-webkit-user-select: none;
-khtml-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
-o-user-select: none;
-webkit-tap-highlight-color:transparent;
" id="canvasClick"></div>
            <canvas id="canvas-608ae3a777867" width="320" height="400" class="mauto dblock overhidden"></canvas>
            <style>
                #canvas-608ae3a777867 {
                    width: 320px;
                    height: 400px;
                }
            </style>
            <script>
                new function() {
                    var canvas = document.getElementById("canvas-608ae3a777867");
                    if (navigator.userAgent.match(/iPhone OS (\w+){1,3}/g)) {
                        var ver = (RegExp.$1.replace(/_/g, '') + '00').slice(0, 3);
                        if (ver >= 700) {
                            var ratio = $("body").innerHeight() / 400;
                            if (ratio < 1) {
                                var w = 320 * ratio;
                                var h = 400 * ratio;
                                canvas.style.paddingLeft = (320 - w) / 2 + "px";
                                canvas.style.width = w + "px";
                                canvas.style.height = h + "px";
                            }
                        }
                    }
                }
            </script>
        </div>
        <script>
            var devicePixelRatio = isAndApp ? 3 : (("devicePixelRatio" in window) ? window.devicePixelRatio : 1);
            var pex, iv, av;
            var pexOpt = {
                'width': 320 * devicePixelRatio,
                'height': 400 * devicePixelRatio,
                'enableButton': true,
                'enableTouch': true,
            }
            if (cv = cVer()) {
                pexOpt['partialDraw'] = false;
            } else if (av = aVer()) {
                // if(av >= 5){
                // 	pexOpt['partialDraw'] = true;
                // 	pexOpt['shapeDetail'] = { 'method':'cache' , 'cacheScale' : '2.0' };
                // }else{
                // 	pexOpt['partialDraw'] = true;
                // 	pexOpt['shapeDetail'] = {'all':{'method':'func'}};
                // }
            } else if (iv = iVer()) {
                pexOpt['partialDraw'] = true;
                pexOpt['shapeDetail'] = {
                    'all': {
                        'method': 'func'
                    }
                };
            } else {
                pexOpt['partialDraw'] = true;
                pexOpt['shapeDetail'] = {
                    'method': 'cache',
                    'cacheScale': '2.0'
                };
            }
            new function() {
                pex = new Pex("?url=http%3A%2F%2Fm.i-sidem.idolmaster.jp%2Fswf%2F2021042803%2Fdrama_replay%2F101%2Ftower_quest77%2Fevent%3Furl%3D%2Fdrama_replay%2Fevent_list%2F5107700%2F1%26cb%3D608ae3a7550fe%26touch%3D1", document.getElementById("canvas-608ae3a777867"), pexOpt);
                window.onunload = function() {
                    pex.getAPI().destroy();
                };
            }

            function iVer() {
                if (/iP(hone|od|ad)/.test(navigator.platform)) {
                    var v = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/);
                    return [parseInt(v[1], 10), parseInt(v[2], 10), parseInt(v[3] || 0, 10)];
                }
            }

            function aVer() {
                var ua = navigator.userAgent;
                if (ua.indexOf("Android") > 0) {
                    var version = parseFloat(ua.slice(ua.indexOf("Android") + 8));
                    return version;
                }
            }

            function cVer() {
                var ua = window.navigator.userAgent.toLowerCase();
                if (ua.indexOf("chrome") > 0) {
                    ar = /chrome\/([\d\.]+)/.exec(ua);
                    var v = ar[1];
                    piv = parseInt(v);
                    if (piv >= 57) {
                        return piv;
                    }
                }
            }
        </script>
        <script>
            var flashVoices = {
                5: {
                    id: 5,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_20_01_wyRoo7QvDq",
                    delay: 0,
                    type: 'first'
                },
                6: {
                    id: 6,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_36_01_5sOgQK65h1",
                    delay: 0
                },
                9: {
                    id: 9,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_33_01_70Cp1q8ZHs",
                    delay: 370
                },
                16: {
                    id: 16,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_33_02_sK6ZjikZYQ",
                    delay: 0
                },
                19: {
                    id: 19,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_42_01_qNr8MpdCKn",
                    delay: 370
                },
                28: {
                    id: 28,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_42_02_udOqXMwPX7",
                    delay: 0
                },
                32: {
                    id: 32,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_36_02_diCDXpChRZ",
                    delay: 370
                },
                35: {
                    id: 35,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_38_01_q4NhpnIk7z",
                    delay: 370
                },
                38: {
                    id: 38,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_20_02_CdhJoabyiS",
                    delay: 370
                },
                41: {
                    id: 41,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_46_01_GvVtsloAXT",
                    delay: 370
                },
                45: {
                    id: 45,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_33_03_Uahlt9yERs",
                    delay: 370
                },
                46: {
                    id: 46,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_20_03_3Gi5yxWxPH",
                    delay: 370
                },
                49: {
                    id: 49,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_46_02_LDm8xs5rOy",
                    delay: 370
                },
                54: {
                    id: 54,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_38_02_SWSVphhAY2",
                    delay: 0
                },
                55: {
                    id: 55,
                    url: "http://img.i-sidem.idolmaster.jp/audio/2021040601/event/tower_quest77/drama101/118_38_03_OXcfyfLmrC",
                    delay: 0,
                    type: 'last'
                },
            };
            var flashCanvas = function() {
                var self = this
                var current_id = parseInt("5");
                var formats = ['aac', 'ogg']
                var is_lock = false
                var is_voice = false
                var is_menu = true
                var flashDatas = {}
                var callbacks = {}
                var audios = {}
                var keys = []
                var played_ids = []

                this.init = function() {
                    for (var key in flashVoices) {
                        var flashAudio = document.createElement('audio');
                        for (var key2 in formats) {
                            if (flashAudio.canPlayType('audio/' + formats[key2])) {
                                flashAudio.src = flashVoices[key].url + '.' + formats[key2]
                                break
                            }
                        }
                        flashAudio.paused = true;
                        flashAudio.datas = flashVoices[key];
                        audios[key] = flashAudio;
                        keys.push(parseInt(key));
                    }
                    $('#canvasClick').on('click', function(event) {
                        return self.clickHandler(event)
                    })
                    $(document).keyup(function(event) {
                        if (event.keyCode == 13) {
                            return self.clickHandler(event)
                        }
                        return false
                    })
                    this.load()
                }
                this.load = function() {
                    for (var i in audios) {
                        audios[i].load()
                    }
                }
                this.initCallback = function() {
                    if (!flashDatas || !flashDatas.dramadata) return false
                    for (var i in flashDatas.dramadata) {
                        callbacks[i] = function(i) {
                            var flashData = self.getFlashDataById(i)
                            if (!flashData) return false
                            var audio = audios[i]
                            if (!audio) return false
                            self.stopAllAudios()
                            if (flashData.voice == "1" && flashData.type == "serif") {
                                if (played_ids.indexOf(i) == -1) {
                                    played_ids.push(i)
                                    self.setDelayAndPlay(audio, audio.datas.delay)
                                }
                            }
                        }
                    }
                }
                this.updateCallback = function(i) {
                    if (!flashDatas || !flashDatas.dramadata) return false
                    var flashData = self.getFlashDataById(i)
                    if (!flashData) return false

                    if (flashData.duration != "") {
                        var next_id = self.getNextId(parseInt(flashData.id))
                        callbacks[next_id] = function() {}
                        callbacks[i] = function(i) {
                            var next_id = self.getNextId(parseInt(i))
                            var flashData = self.getFlashDataById(next_id)
                            if (!flashData) return false
                            var audio = audios[next_id]
                            if (!audio) return false
                            self.stopAllAudios()
                            if (flashData.type == "serif") {
                                if (played_ids.indexOf(next_id) == -1) {
                                    played_ids.push(next_id)
                                    self.setDelayAndPlay(audio, audio.datas.delay)
                                }
                            }
                        }
                        return true
                    }
                    return false
                }
                this.clickHandler = function(event) {
                    if (is_menu) return false
                    if (is_lock) return false
                    is_lock = true
                    var currentAudio = this.callVoice(current_id)
                    if (!this.isFirst(currentAudio)) {
                        this.stopAllAudios()
                    }
                    if (this.isLast(currentAudio)) {
                        is_lock = false
                        $('#canvasClick').addClass('dnone')
                    }
                    var next_id = this.getNextId(current_id)
                    this.setCurrentId(next_id)
                    var cb = this.getCallback(current_id)
                    if (cb) cb(current_id)
                    movieCtr('step')
                    return false
                }
                this.setDelayAndPlay = function(audio, delay) {
                    var delay = delay ? parseInt(delay) : 0
                    // audio用にtimeoutを1秒(1000)以上指定するとバグが発生する可能性があるので変えない（多機種対応のため）
                    delay = delay >= 550 ? 549 : delay
                    window.setTimeout(function() {
                        self.playAudio(audio)
                    }, delay)
                }
                this.playAudio = function(audio) {
                    if (!audio) return false
                    if (typeof mobage !== 'undefined') {
                        mobage.shellapp.Music.pause();
                    }
                    if (window.bgmAudio && typeof window.bgmAudio == 'object') {
                        window.bgmAudio.pause()
                    }
                    audio.currentTime = 0
                    audio.play()
                }
                this.isFirst = function(audio) {
                    if (!audio || !audio.datas) return false
                    return (audio.datas.type == 'first')
                }
                this.isLast = function(audio) {
                    if (!audio || !audio.datas) return false
                    return (audio.datas.type == 'last')
                }
                this.displayVoiceMenu = function() {
                    var canvasClick = $('#canvasClick')
                    canvasClick.removeClass('dnone')
                    var btn = $('<a class="dblock posa"></a>')
                    btn.css({
                        textIndent: '-9999px',
                        width: '210px',
                        height: '43px',
                        left: '55px'
                    })

                    var btnNo = btn.clone()
                    btnNo.css('top', '166px');
                    btnNo.html('no')
                    btnNo.on('click', function(event) {
                        event.preventDefault()
                        is_menu = false
                        is_voice = false
                        canvasClick.find('a').remove()
                        movieCtr('window_close')
                        movieCtr('step')
                        event.stopPropagation()
                        return false
                    })
                    var btnYes = btn.clone()
                    btnYes.css('top', '116px');
                    btnYes.html('yes')
                    btnYes.on('click', function(event) {
                        event.preventDefault()
                        is_menu = false
                        is_voice = true
                        self.initCallback()
                        canvasClick.find('a').remove()
                        self.clickHandler()
                        movieCtr('window_close')
                        movieCtr('step')
                        event.stopPropagation()
                        return false
                    })

                    canvasClick.append(btnNo)
                    canvasClick.append(btnYes)
                }

                this.displaySkip = function() {
                    var canvasClick = $('#canvasClick')
                    canvasClick.removeClass('dnone')
                    var btnSkip = $('<a class="dblock posa"></a>')
                    btnSkip.css({
                        textIndent: '-9999px',
                        width: '50px',
                        height: '15px',
                        left: '253px',
                        top: '364px'
                    })
                    btnSkip.html('skip')
                    btnSkip.on('click', function(event) {
                        event.preventDefault()
                        movieCtr('skip')
                        event.stopPropagation()
                        return false
                    })
                    canvasClick.append(btnSkip)
                }
                this.stopAllAudios = function() {
                    for (var i in audios) {
                        var audio = audios[i]
                        if (audio) {
                            audio.pause()
                        }
                    }
                }
                this.callVoice = function(id) {
                    return audios[id]
                }
                this.toggleLock = function(lock) {
                    is_lock = lock
                }
                this.getNextId = function(id) {
                    var last_id = keys[keys.length - 1]
                    id++
                    if (keys.indexOf(id) === -1 && id <= last_id) {
                        id = this.getNextId(id)
                    }
                    return id
                }

                this.setCurrentId = function(id) {
                    current_id = id
                }
                this.getCallbacks = function() {
                    return callbacks
                }
                this.getCallback = function(id) {
                    return callbacks[id] || null
                }
                this.setFlashDatas = function(data) {
                    flashDatas = jQuery.parseJSON(data)
                    flashDatas.dramadata.unshift({})
                }
                this.getFlashDatas = function() {
                    return flashDatas
                }
                this.getFlashDataById = function(id) {
                    return flashDatas.dramadata[id]
                }
                this.setAudioEndedEvents = function() {
                    audio = audios[1]
                    //console.log(audio);
                    //audio.addEventListener('loadstart', function() {
                    //	console.log('loadstart', this.src)
                    //}, false)
                    //audio.addEventListener('timeupdate', function() {
                    //        console.log('timeupdate', this.currentTime)
                    //}, false)
                    console.log(audio);
                    audio.addEventListener('ended', function() {
                        movieCtr('voice_end')
                    }, false)
                }
                this.isVoice = function() {
                    return is_voice
                }
                return this
            }
            var _canvas = flashCanvas()
            _canvas.init()
            /**************************************/
            /***** FLASHから呼び出すfunctions *****/
            var pexApi = pex.getAPI()
            var timeoutId;
            var indexcount = function(c) {
                if (c) {
                    if (_canvas.isVoice()) {
                        _canvas.toggleLock(true)
                        clearTimeout(timeoutId)
                        timeoutId = setTimeout(function() {
                            _canvas.toggleLock(false)
                        }, 1000)
                    } else {
                        _canvas.toggleLock(false)
                    }
                    _canvas.setCurrentId(c)
                } else {
                    _canvas.setCurrentId(0)
                }
            }
            var movieCtr = function(mode) {
                pexApi.gotoAndStop("main/component", mode)
            }
            var showButtons = function() {
                _canvas.displayVoiceMenu()
            }
            var skipButton = function() {
                _canvas.displaySkip()
            }
            var flashclick = function(c) {
                if (!_canvas.isVoice()) {
                    return false
                }
                if (_canvas.updateCallback(c - 1)) {
                    var cb = _canvas.getCallback(c - 1)
                    if (cb) cb(c - 1)
                }
            }
            var getAudioEnded = function() {
                _canvas.setAudioEndedEvents()
            }
            var dramaValues = function(data) {
                _canvas.setFlashDatas(data)
            }
            var trace = function(v) {}
        </script>
        <script>
            var canvasCenteredTrigger = function() {
                var e = document.documentElement,
                    t = Math.max(e.clientHeight, e.offsetHeight),
                    a = document.getElementsByTagName("canvas")[0],
                    n = Math.max(a.offsetHeight),
                    o = parseFloat($(document.body).css("zoom").replace("px", ""));
                n *= o;
                var r = (t - n) / 2;
                0 > r && (r = 0), r /= o, r = Math.floor(r), $("#layout").css({
                    paddingTop: r + "px"
                })
            };
            $(document).on("ready", function() {
                canvasCenteredTrigger()
            }), $(window).resize(function() {
                canvasCenteredTrigger()
            });
        </script>
        <style type="text/css">
            input {
                visibility: hidden;
            }
        </style>
    </div>
</body>

</html>